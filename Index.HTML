<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏ú‡∏ô‡∏Å‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #475569;
            --success: #059669;
            --danger: #dc2626;
            --warning: #d97706;
            --bg-site: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sub: #ffffff;
            --border: #cbd5e1;
            --sidebar-width: 280px;
            --font-main: 'Sarabun', 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: var(--font-main);
        }

        body {
            background-color: var(--bg-site);
            padding: 20px 20px 20px calc(var(--sidebar-width) + 20px);
            color: var(--text-main);
        }

        /* Sidebar Styling */
        .history-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: var(--sidebar-width);
            background: #ffffff;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 4px 0 15px rgba(0, 0, 0, 0.03);
        }

        .sidebar-header {
            padding: 24px;
            border-bottom: 2px solid var(--primary);
            background: #fff;
        }

        .sidebar-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .history-item {
            background: #fff;
            padding: 12px 12px 12px 45px;
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            user-select: none;
        }

        .history-item:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 16px rgb(255, 255, 255);
            transform: translateX(4px);
        }

        .history-item.selected {
            border-color: var(--primary);
            background: #f5f3ff;
        }

        .item-checkbox {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .history-item .date {
            font-weight: 700;
            font-size: 0.95rem;
            margin-bottom: 4px;
            color: var(--text-main);
        }

        .history-item .timestamp {
            font-size: 0.75rem;
            color: var(--text-sub);
        }

        .delete-btn {
            position: absolute;
            bottom: 10px;
            right: 12px;
            color: var(--danger);
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 4px;
            border-radius: 4px;
        }

        .history-item:hover .delete-btn {
            opacity: 0.6;
        }

        .delete-btn:hover {
            opacity: 1 !important;
            background: #fee2e2;
        }

        .edit-btn {
            position: absolute;
            bottom: 10px;
            right: 40px;
            color: var(--secondary);
            border: none;
            background: none;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.2s;
            padding: 4px;
            border-radius: 4px;
        }

        .history-item:hover .edit-btn {
            opacity: 0.6;
        }

        .edit-btn:hover {
            opacity: 1 !important;
            background: #e0f2fe;
            color: var(--primary);
        }

        .sidebar-actions {
            padding: 10px 16px;
            border-bottom: 1px solid var(--border);
            background: #fafafa;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-sub);
        }

        #print-area {
            display: none;
        }

        @media print {
            @page {
                size: landscape;
                margin: 0;
            }

            #print-area {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
        }


        /* Sheet Container Styling */
        .sheet-container {
            width: 297mm;
            min-height: 209mm;
            background: var(--bg-card);
            margin: 0 auto 30px auto;
            padding: 10mm;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            position: relative;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .form-header {
            display: flex;
            border: 1px solid #000;
            background: #fff;
            align-items: stretch;
        }

        .logo-box {
            width: 250px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            border-right: 1px solid #000;
            padding: 5px 10px;
        }

        .company-name {
            font-weight: 800;
            font-size: 1rem;
        }

        .form-title {
            padding: 10px;
            text-align: center;
        }

        .form-meta {
            width: 220px;
            font-size: 0.75rem;
            padding: 8px;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            justify-content: center;
            line-height: 1.5;
        }

        .main-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        .main-table th,
        .main-table td {
            border: 1px solid #000;
            padding: 2px 4px;
            line-height: 1.1;
        }

        .main-table th {
            background: #f1f5f9;
            font-weight: 700;
        }

        .category-cell {
            background: #fff;
            font-weight: 700;
            color: #000;
            text-align: center;
            width: 35px;
            padding: 0 !important;
        }

        .vertical-text {
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            padding: 10px 5px;
            display: inline-block;
            font-size: 0.7rem;
        }

        .col-item {
            width: 180px;
        }

        .col-std {
            width: 180px;
        }

        .check-cell {
            text-align: center;
            cursor: pointer;
            font-weight: 800;
            width: 28px;
            transition: background 0.1s;
        }

        .check-cell:hover {
            background: #f1f5f9 !important;
        }

        .status-ok {
            color: var(--success);
        }

        .status-bad {
            color: var(--danger);
            background: #fef2f2 !important;
        }

        .status-na {
            color: #94a3b8;
        }

        .footer-section {
            margin-top: 15px;
            border: 1px solid #000;
            padding: 10px;
            background: #fff;
        }

        .signature-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.75rem;
        }

        .signature-table td {
            border: 1px solid #000;
            text-align: center;
            padding: 5px;
            height: 40px;
        }

        .date-input {
            border: 1px dashed #cbd5e1;
            background: #fff;
            font-size: 0.75rem;
            color: var(--text-main);
            outline: none;
            width: auto;
            text-align: center;
            cursor: pointer;
            padding: 2px 5px;
            border-radius: 4px;
        }

        /* Controls */
        .controls {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 16px;
            z-index: 1000;
            width: 220px;
            border: 1px solid var(--border);
        }

        .btn {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }

        .btn-outline {
            background: white;
            border: 1.5px solid var(--border);
            color: var(--text-main);
        }

        .btn-outline:hover {
            background: #f8fafc;
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .custom-modal {
            background: white;
            padding: 24px;
            border-radius: 20px;
            width: 400px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        @media print {
            body {
                padding: 0 !important;
                background: white;
            }

            .history-sidebar,
            .controls,
            .modal-overlay,
            .no-print {
                display: none !important;
            }

            .sheet-container {
                border: none !important;
                box-shadow: none !important;
                padding: 5mm !important;
                margin: 0 !important;
                width: 297mm !important;
                height: 209mm !important;
                page-break-after: always;
                overflow: hidden;
            }

            .main-table {
                font-size: 0.65rem !important;
            }

            .main-table th,
            .main-table td {
                padding: 1px 2px !important;
            }

            .date-input {
                border: none;
                padding: 0;
                -webkit-appearance: none;
                -moz-appearance: none;
                appearance: none;
            }

            .date-input::-webkit-calendar-picker-indicator {
                display: none;
            }

            .vertical-text {
                font-size: 0.6rem !important;
                padding: 2px !important;
            }
        }
    </style>

</head>

<body>
    <div id="saveModal" class="modal-overlay">
        <div class="custom-modal">
            <h3 style="margin-bottom: 15px;">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
            <p style="font-size: 0.9rem; color: #6b7280; margin-bottom: 10px;">‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</p>
            <input type="text" id="modalInput"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid #ddd; margin-bottom: 20px;">
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="document.getElementById('saveModal').style.display='none'" class="btn"
                    style="width:auto; padding: 8px 20px; background:#f3f4f6;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmSaveHistory()" class="btn btn-primary"
                    style="width:auto; padding: 8px 20px;">‡∏ï‡∏Å‡∏•‡∏á</button>
            </div>
        </div>
    </div>

    <div id="loadModal" class="modal-overlay">
        <div class="custom-modal">
            <h3 style="margin-bottom: 15px;">üìÇ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤</h3>
            <p id="loadModalText" style="margin-bottom: 20px;"></p>
            <div style="display:flex; gap:10px; justify-content:flex-end;">
                <button onclick="document.getElementById('loadModal').style.display='none'" class="btn"
                    style="width:auto; padding: 8px 20px; background:#f3f4f6;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirmLoadBtn" class="btn btn-primary"
                    style="width:auto; padding: 8px 20px;">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>

    <div class="history-sidebar no-print">
        <div class="sidebar-header">
            <div class="sidebar-title">üìã ‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
            <select id="fmtSelector" onchange="switchFMT(this.value)"
                style="width: 100%; padding: 8px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border); font-family: var(--font-main);">
                <option value="02">FMT-02 (‡∏â‡∏µ‡∏î‡πÇ‡∏ü‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô)</option>
                <option value="37">FMT-37 (‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®)</option>

            </select>
        </div>
        <div class="sidebar-header">
            <div class="sidebar-title">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</div>
            <div style="font-size: 0.75rem; color: var(--text-sub); margin-top: 5px;">‡∏ù‡πà‡∏≤‡∏¢ / ‡πÅ‡∏ú‡∏ô‡∏Å ‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á</div>
        </div>
        <div class="sidebar-actions">
            <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)" style="cursor: pointer;">
            <label for="selectAll" style="cursor: pointer; font-weight: 600;">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
            <button onclick="syncFromCloud()"
                style="margin-left: auto; border: none; background: none; cursor: pointer; color: var(--primary);"
                title="‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud">
                ‚òÅÔ∏è Sync
            </button>
        </div>
        <div class="sidebar-content" id="history-list">
            <!-- Items injected here -->
        </div>
    </div>

    <div class="controls no-print">
        <div id="statusBadge"
            style="padding: 8px; background: #fee2e2; color: #991b1b; font-size: 0.75rem; text-align: center; border-radius: 8px; margin-bottom: 10px; display: none; font-weight: bold; border: 1px solid #fecaca;">
            üëÄ Viewing History</div>

        <button id="editToggleBtn" class="btn" onclick="toggleEditMode()"
            style="display: none; background: #3b82f6; color: white;"><span>‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ</span></button>
        <button id="updateBtn" class="btn" onclick="updateCurrentHistory()"
            style="display: none; background: var(--warning); color: white;"><span>üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°</span></button>
        <button class="btn btn-primary" onclick="saveToHistory()"><span>üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà</span></button>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="btn btn-success" onclick="markAllNormal()"
                style="font-size: 0.75rem; padding: 10px 5px;"><span>‚úÖ ‡∏ï‡∏¥‡πä‡∏Å‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></button>
            <button class="btn btn-danger" onclick="clearAll()" style="font-size: 0.75rem; padding: 10px 5px;"><span>üóëÔ∏è
                    ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span></button>
        </div>

        <hr style="margin: 15px 0; border: 0; border-top: 1px solid var(--border);">

        <button class="btn btn-primary" onclick="printSelected()" id="printSelectedBtn"
            style="background: #000; display: none;">
            <span>üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
        </button>

        <button class="btn btn-outline" onclick="window.print()">
            <span>üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
        </button>
    </div>

    <div id="print-area"></div>


    <div id="forms-container"></div>

    <script>
        let currentFMT = 2;
        let currentLoadedId = null;
        let pendingLoadItem = null;

        // Drag-to-fill variables
        let isDragging = false;
        let dragStartState = 0;
        let dragStartCell = null;

        // Helper functions for Thai dates (Buddhist Era)
        const thaiMonths = [
            '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
            '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
        ];

        function toBuddhistYear(year) {
            return parseInt(year) + 543;
        }

        function formatThaiDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            const day = date.getDate();
            const month = date.getMonth() + 1;
            const year = toBuddhistYear(date.getFullYear());
            return `${day}/${month}/${year}`;
        }

        function toThaiDateStr(dateStr) {
            return formatThaiDate(dateStr);
        }

        function getCurrentThaiYear() {
            return toBuddhistYear(new Date().getFullYear());
        }

        const checklistData37 = [
            {
                category: "‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏û‡πà‡∏ß‡∏á (Computer & Peripherals)",
                items: [
                    { name: "1. ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ (Monitor)", std: "‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å‡∏£‡πâ‡∏≤‡∏ß, ‡∏†‡∏≤‡∏û‡∏Ñ‡∏°‡∏ä‡∏±‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡πâ‡∏ô" },
                    { name: "2. ‡∏ï‡∏±‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Case/CPU)", std: "‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡∏û‡∏±‡∏î‡∏•‡∏°‡∏´‡∏°‡∏∏‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥" },
                    { name: "3. ‡πÅ‡∏õ‡πâ‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏°‡∏≤‡∏™‡πå", std: "‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏∏‡πà‡∏°, ‡πÑ‡∏°‡πà‡∏Ñ‡πâ‡∏≤‡∏á" },
                    { name: "4. ‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏±‡πä‡∏Å (Power Cord)", std: "‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏â‡∏µ‡∏Å‡∏Ç‡∏≤‡∏î, ‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡πÅ‡∏ô‡πà‡∏ô, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥" },
                    { name: "5. ‡∏™‡∏≤‡∏¢ LAN (LAN Cable)", std: "‡∏™‡∏†‡∏≤‡∏û‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå, ‡∏´‡∏±‡∏ß‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å, ‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡πÅ‡∏ô‡πà‡∏ô" },
                    { name: "6. ‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Machine ID)", std: "‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô, ‡∏ï‡∏¥‡∏î‡πÅ‡∏ô‡πà‡∏ô" }
                ]
            },
            {
                category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÅ‡∏•‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå (Printer & Scanner)",
                items: [
                    { name: "7. ‡∏ñ‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡∏∞‡∏•‡∏π‡∏Å‡∏Å‡∏•‡∏¥‡πâ‡∏á", std: "‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡πà‡∏á‡πÅ‡∏õ‡∏•‡∏Å‡∏õ‡∏•‡∏≠‡∏°, ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î" },
                    { name: "8. ‡∏ï‡∏•‡∏±‡∏ö‡∏´‡∏°‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå", std: "‡∏õ‡∏£‡∏¥‡∏°‡∏≤‡∏ì‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠, ‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡πÄ‡∏õ‡∏∑‡πâ‡∏≠‡∏ô" },
                    { name: "9. ‡∏Å‡∏£‡∏∞‡∏à‡∏Å‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå", std: "‡∏™‡∏∞‡∏≠‡∏≤‡∏î, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≠‡∏¢‡∏Ç‡∏µ‡∏î‡∏Ç‡πà‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏£‡∏≤‡∏ö" }
                ]
            },
            {
                category: "‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ü (UPS)",
                items: [
                    { name: "10. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÑ‡∏ü‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Status)", std: "‡πÑ‡∏ü‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏õ‡∏Å‡∏ï‡∏¥, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ú‡∏¥‡∏î‡∏õ‡∏Å‡∏ï‡∏¥" },
                    { name: "11. ‡∏™‡∏†‡∏≤‡∏û‡∏ï‡∏±‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà", std: "‡πÑ‡∏°‡πà‡∏ö‡∏ß‡∏°, ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡πâ‡∏≠‡∏ô‡∏™‡∏π‡∏á, ‡∏™‡∏≤‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡πÅ‡∏ô‡πà‡∏ô" }
                ]
            },
            {
                category: "‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏° (Environmental)",
                items: [
                    { name: "12. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡πÅ‡∏•‡∏∞‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö", std: "‡∏à‡∏±‡∏î‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢, ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ñ‡πà‡∏≤‡∏¢‡πÄ‡∏ó‡∏î‡∏µ" }
                ]
            }
        ];

        const checklistData02 = [
            {
                category: "‡∏£‡∏∞‡∏ö‡∏ö SAFETY",
                items: [
                    { name: "‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤", std: "‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ‡πÑ‡∏î‡πâ‡∏™‡∏∞‡∏î‡∏ß‡∏Å" },
                    { name: "Limit switch ‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤", std: "‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î - ‡∏õ‡∏¥‡∏î‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏ô" },
                    { name: "‡∏ï‡∏±‡∏ß‡∏•‡πá‡∏≠‡∏Ñ ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤", std: "‡∏•‡πá‡∏≠‡∏Ñ‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÑ‡∏î‡πâ‡πÅ‡∏ô‡πà‡∏ô" },
                    { name: "EMERGENCY STOP", std: "‡∏Å‡∏î‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î" }
                ]
            },
            {
                category: "‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏ü‡∏ü‡πâ‡∏≤",
                items: [
                    { name: "‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°", std: "‡∏™‡∏∞‡∏≠‡∏≤‡∏î ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡∏≠‡∏á‡∏ß‡∏≤‡∏á‡πÄ‡∏Å‡∏∞‡∏Å‡∏∞" },
                    { name: "‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°", std: "‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö ‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î" },
                    { name: "‡∏™‡∏≤‡∏¢‡πÑ‡∏ü‡∏ü‡πâ‡∏≤‡∏ó‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á", std: "‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ö/ ‡∏£‡πâ‡∏≠‡∏¢‡∏ó‡πà‡∏≠/ ‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î" },
                    { name: "Switch Control", std: "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏î‡∏µ ‡πÑ‡∏°‡πà‡∏ä‡∏≥‡∏£‡∏∏‡∏î" },
                    { name: "‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏ï‡∏π‡πâ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°", std: "‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≠‡∏ô ‡πÑ‡∏´‡∏°‡πâ ‡∏≠‡∏±‡∏î‡πÅ‡∏ô‡πà‡∏ô" }
                ]
            },
            {
                category: "‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏Æ‡∏î‡∏£‡∏≠‡∏•‡∏¥‡∏Ñ",
                items: [
                    { name: "Solenoid Valve", std: "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏£‡∏±‡πà‡∏ß" },
                    { name: "‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å‡∏™‡∏π‡∏ö", std: "‡∏¢‡∏∂‡∏î‡πÅ‡∏ô‡πà‡∏ô ‡πÑ‡∏°‡πà‡∏£‡∏±‡πà‡∏ß" },
                    { name: "‡πÅ‡∏£‡∏á‡∏î‡∏±‡∏ô Mold press", std: "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ñ‡πà‡∏≤ 80-120 ‡∏ö‡∏≤‡∏£‡πå" },
                    { name: "‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", std: "‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î" }
                ]
            },
            {
                category: "‡∏£‡∏∞‡∏ö‡∏ö Steam",
                items: [
                    { name: "Valve Steam", std: "‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏£‡∏±‡πà‡∏ß" },
                    { name: "Pressur gauge contactor", std: "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ï‡∏±‡∏î-‡∏ï‡πà‡∏≠ ‡∏õ‡∏Å‡∏ï‡∏¥" },
                    { name: "Glove Valve", std: "‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏£‡∏±‡πà‡∏ß" },
                    { name: "Pressur gauge contactor", std: "‡∏™‡∏≤‡∏¢‡∏™‡∏ï‡∏£‡∏µ‡∏°‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å ‡πÑ‡∏°‡πà‡∏£‡∏±‡πà‡∏ß" }
                ]
            },
            {
                category: "‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏°",
                items: [
                    { name: "Solenoid Valve", std: "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏£‡∏±‡πà‡∏ß" },
                    { name: "‡∏™‡∏≤‡∏¢‡∏•‡∏°", std: "‡πÑ‡∏°‡πà‡∏£‡∏±‡πà‡∏ß ‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏Å" }
                ]
            },
            {
                category: "‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡πâ‡∏≥",
                items: [
                    { name: "Solenoid Valve", std: "‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏õ‡∏Å‡∏ï‡∏¥ ‡πÑ‡∏°‡πà‡∏£‡∏±‡πà‡∏ß" }
                ]
            },
            {
                category: "‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏•",
                items: [
                    { name: "‡πÄ‡∏û‡∏•‡∏≤‡∏ï‡πà‡∏≤‡∏á ‡πÜ", std: "‡∏°‡∏µ‡∏à‡∏≤‡∏£‡∏∞‡∏ö‡∏µ ‡πÑ‡∏°‡πà‡πÇ‡∏Ñ‡πâ‡∏á‡∏á‡∏≠" }
                ]
            }
        ];

        window.addEventListener('load', () => {
            renderHistoryList();
            renderAllTables();
        });

        function switchFMT(val) {
            currentFMT = parseInt(val);
            renderAllTables();
            renderHistoryList();
        }

        function renderAllTables() {
            document.getElementById('forms-container').innerHTML = '';
            if (currentFMT === 37) {
                renderExactTable37(1, 20);
                renderExactTable37(21, 40);
                renderExactTable37(41, 54);
            } else if (currentFMT === 2) {
                renderExactTable02();
            }
        }

        function toThaiDigits(str) {
            return str; // Return as is (Arabic numerals)
        }

        function toThaiDateStr(dateStr) {
            if (!dateStr) return "";
            const [y, m, d] = dateStr.split('-');
            const beYear = parseInt(y) + 543;
            return `${d}/${m}/${beYear}`;
        }


        function renderExactTable37(startNum, endNum) {
            const div = document.createElement('div');
            div.className = 'sheet-container';

            let machineHeaders = '';
            for (let i = 0; i < 20; i++) {
                let num = startNum + i;
                let isExist = num <= 54;
                machineHeaders += `<th style="width: 28px; text-align: center; cursor: ${isExist ? 'pointer' : 'default'}" ${isExist ? `onclick="toggleColumn(${num})"` : ''}>${isExist ? num : ''}</th>`;
            }

            let rowsHtml = '';
            checklistData37.forEach(group => {
                group.items.forEach((item, idx) => {
                    rowsHtml += `<tr>
                        ${idx === 0 ? `<td rowspan="${group.items.length}" class="category-cell"><div class="vertical-text">${group.category}</div></td>` : ''}
                        <td class="col-item" style="font-size:0.75rem;">${item.name}</td>
                        <td class="col-std" style="font-size:0.7rem;">${item.std}</td>`;
                    for (let i = 0; i < 20; i++) {
                        let num = startNum + i;
                        let isExist = num <= 54;
                        rowsHtml += `<td class="check-cell mach-${num}" data-state="0" data-num="${num}" style="background: ${isExist ? '#fff' : '#fdfdfd'}"></td>`;
                    }
                    rowsHtml += `<td contenteditable="true" class="row-remark"></td></tr>`;
                });
            });

            const thaiDate = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

            div.innerHTML = `
                <header class="form-header">
                    <div class="logo-box">‚óÜ</div>
                    <div class="company-name">POLYFOAM HIGH-TECH (PFH)</div>
                    <div class="form-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</div>
                    <div class="form-meta">
                        <div><b>Doc No:</b> FMT-37</div>
                        <div><b>Revision:</b> 00</div>
                        <div><b>Eff. Date:</b> 01/01/2567</div>
                        <div style="margin-top:2px; color:var(--primary); font-weight:bold;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${thaiDate}</div>
                    </div>
                </header>

                <table class="main-table">
                    <thead>
                        <tr>
                            <th rowspan="2">‡∏´‡∏°‡∏ß‡∏î</th>
                            <th rowspan="2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                            <th rowspan="2">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</th>
                            <th colspan="20">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Machine No.)</th>
                            <th rowspan="2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                        </tr>
                        <tr>${machineHeaders}</tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
                <div class="footer-section">
                    <div style="display:flex; justify-content: space-between; gap: 20px;">
                        <div style="flex:1.5;">
                            <div style="font-weight:bold; margin-bottom: 5px; border-bottom: 2px solid var(--primary); display: inline-block; font-size:0.85rem;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Action Taken)</div>
                            <div class="correction-input" contenteditable="true" style="min-height: 80px; border: 1px dashed #000; padding: 8px; font-size: 0.8rem; background:#fff;"></div>
                            <div style="display:flex; margin-top:10px; gap:15px; font-size: 0.75rem;">
                                <strong>‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå:</strong>
                                <span><b style="color:var(--success)">/</b> ‡∏õ‡∏Å‡∏ï‡∏¥</span>
                                <span><b style="color:var(--danger)">X</b> ‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥</span>
                                <span><b>-</b> ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</span>
                            </div>
                        </div>
                        <div style="flex:1;">
                            <table class="signature-table">
                                <tr>
                                    <td>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Recorder)</td>
                                    <td>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ (Checker)</td>
                                    <td>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approver)</td>
                                </tr>
                                <tr style="height:50px;"><td></td><td></td><td></td></tr>
                                <tr>
                                    <td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="thai-date-display"></span><input type="date" class="date-input" onchange="this.previousElementSibling.innerText = toThaiDateStr(this.value)"></td>
                                    <td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="thai-date-display"></span><input type="date" class="date-input" onchange="this.previousElementSibling.innerText = toThaiDateStr(this.value)"></td>
                                    <td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <span class="thai-date-display"></span><input type="date" class="date-input" onchange="this.previousElementSibling.innerText = toThaiDateStr(this.value)"></td>
                                </tr>
                            </table>

                        </div>
                    </div>
                </div>`;
            document.getElementById('forms-container').appendChild(div);
        }

        function renderExactTable02() {
            const div = document.createElement('div');
            div.className = 'sheet-container';

            let dateHeaders = '';
            for (let i = 1; i <= 31; i++) {
                dateHeaders += `<th style="width: 20px; text-align: center; cursor: pointer" onclick="toggleColumn(${i})">${i}</th>`;
            }

            let rowsHtml = '';
            checklistData02.forEach(group => {
                // Category Header Row
                rowsHtml += `<tr style="background: #fdfdfd;">
                    <td colspan="2" style="text-align: left; font-weight: bold; padding-left: 5px; font-size: 0.8rem; height: 22px; border: 1px solid #000;">${group.category}</td>
                    ${Array(31).fill('<td style="border: 1px solid #000; background: #fafafa;"></td>').join('')}
                </tr>`;

                group.items.forEach((item, idx) => {
                    rowsHtml += `<tr>
                        <td class="col-item" style="font-size:0.75rem; padding-left: 15px; border: 1px solid #000;">${item.name}</td>
                        <td class="col-std" style="font-size:0.7rem; border: 1px solid #000;">${item.std}</td>`;
                    for (let i = 1; i <= 31; i++) {
                        rowsHtml += `<td class="check-cell mach-${i}" data-state="0" data-num="${i}" style="border: 1px solid #000;"></td>`;
                    }
                    rowsHtml += `</tr>`;
                });
            });

            const thaiDate = new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long' });

            div.innerHTML = `
                <div style="border: 2px solid #000; margin-bottom: 0;">
                    <div class="form-header" style="border: none; border-bottom: 2px solid #000;">
                        <div class="logo-box" style="border-right: 2px solid #000; padding: 8px 15px; width: auto; flex: 1;">
                            <div class="company-name" style="font-size: 1rem; font-weight: 700;">POLYFOAM HIGH-TECH (PFH)</div>
                        </div>
                        <div class="form-title" style="flex: 2; display: flex; align-items: center; justify-content: center; padding: 8px; border-right: 2px solid #000; font-size: 1rem; font-weight: 700; text-align: center;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏â‡∏µ‡∏î‡πÇ‡∏ü‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</div>
                        <div style="flex: 1.2; padding: 6px 10px; display: flex; align-items: center; gap: 6px; font-size: 0.7rem;">
                            <b>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b>
                            <select class="fmt02-month-select" style="padding: 2px 4px; border: 1px solid #000; font-size: 0.65rem;">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</option>
                                ${thaiMonths.map((m, i) => `<option value="${i + 1}">${m}</option>`).join('')}
                            </select>
                            <select class="fmt02-year-select" style="padding: 2px 4px; border: 1px solid #000; font-size: 0.65rem;">
                                <option value="">‡∏õ‡∏µ</option>
                                ${Array.from({ length: 10 }, (_, i) => getCurrentThaiYear() - 5 + i).map(y => `<option value="${y}">${y}</option>`).join('')}
                            </select>
                            <b style="margin-left: auto;">FMT-02</b>
                            <b style="margin-left: 10px;">Re:#0</b>
                        </div>
                    </div>

                    <div style="display: flex; border-bottom: 2px solid #000; font-size: 0.8rem;">
                        <div style="flex: 1.2; padding: 6px 10px; border-right: 2px solid #000;">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç / Machine No.: <span contenteditable="true" class="fmt02-m-no" style="border-bottom: 1px solid #000; display: inline-block; min-width: 80px;"></span></div>
                        <div style="flex: 2; padding: 6px 10px; border-right: 2px solid #000;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/Machine Name : <span style="font-weight: bold;">INJECTION MOLDING FOAM</span></div>
                        <div style="flex: 0.9; padding: 6px 10px; border-right: 2px solid #000;">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á:‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï    </div>
                        
                    </div>
                </div>

                <table class="main-table" style="font-size: 0.65rem; border-top: none;">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width:130px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</th>
                            <th rowspan="2" style="width:130px;">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</th>
                            <th colspan="31">Date/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        </tr>
                        <tr>${dateHeaders}</tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
                <div style="border: 2px solid #000; border-top: none; padding: 0; margin-top: 0;">
                    <div style="display:flex;">
                        <div style="flex: 2; padding: 10px 15px; border-right: 2px solid #000; display: flex; flex-direction: column; gap: 8px;">
                            <div style="font-size: 0.85rem; font-weight: bold;">
                                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ &nbsp;&nbsp;&nbsp; ‡∏£‡∏∞‡∏ö‡∏∏ &nbsp; / &nbsp; ‡∏õ‡∏Å‡∏ï‡∏¥ &nbsp;&nbsp; X &nbsp;&nbsp; ‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥
                            </div>
                            <div style="font-size: 0.75rem; line-height: 1.4;">
                                ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≠‡∏™‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏ß‡πÑ‡∏´‡∏•‡∏´‡∏•‡∏±‡πà‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            </div>
                        </div>
                        <div style="flex: 1.2; padding: 0;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">
                                <tr style="height: 25px;">
                                    <td style="border: 1px solid #000; border-left: none; border-top: none; text-align: center; width: 60px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠</td>
                                    <td style="border: 1px solid #000; border-top: none; text-align: center;">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td>
                                    <td style="border: 1px solid #000; border-top: none; text-align: center;">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</td>
                                    <td style="border: 1px solid #000; border-right: none; border-top: none; text-align: center;">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</td>
                                </tr>
                                <tr style="height: 35px;">
                                    <td style="border: 1px solid #000; border-left: none; text-align: center;">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</td>
                                    <td style="border: 1px solid #000;"></td>
                                    <td style="border: 1px solid #000;"></td>
                                    <td style="border: 1px solid #000; border-right: none;"></td>
                                </tr>
                                <tr style="height: 25px;">
                                    <td style="border: 1px solid #000; border-left: none; text-align: center; font-size: 0.65rem;">‡∏ä‡∏∑‡πà‡∏≠ (‡∏ï‡∏±‡∏ß‡∏ö‡∏£‡∏£‡∏à‡∏á)</td>
                                    <td style="border: 1px solid #000; padding: 2px;"><span contenteditable="true" class="sig-name" style="display: block; outline: none; text-align: center;"></span></td>
                                    <td style="border: 1px solid #000; padding: 2px;"><span contenteditable="true" class="sig-name" style="display: block; outline: none; text-align: center;"></span></td>
                                    <td style="border: 1px solid #000; border-right: none; padding: 2px;"><span contenteditable="true" class="sig-name" style="display: block; outline: none; text-align: center;"></span></td>
                                </tr>
                                <tr style="height: 25px;">
                                    <td style="border: 1px solid #000; border-left: none; border-bottom: none; text-align: center;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</td>
                                    <td style="border: 1px solid #000; border-bottom: none; text-align: center; padding: 2px;"><input type="date" class="date-input" style="width: 100%; border: none; text-align: center; font-size: 0.65rem;"></td>
                                    <td style="border: 1px solid #000; border-bottom: none; text-align: center; padding: 2px;"><input type="date" class="date-input" style="width: 100%; border: none; text-align: center; font-size: 0.65rem;"></td>
                                    <td style="border: 1px solid #000; border-right: none; border-bottom: none; text-align: center; padding: 2px;"><input type="date" class="date-input" style="width: 100%; border: none; text-align: center; font-size: 0.65rem;"></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>`;
            document.getElementById('forms-container').appendChild(div);
        }

        function toggle(cell) {
            if (!isDragging) {
                setCellState(cell, (parseInt(cell.dataset.state) + 1) % 4);
            }
        }

        function setCellState(cell, state) {
            cell.dataset.state = state;
            cell.classList.remove('status-ok', 'status-bad', 'status-na');
            if (state === 1) { cell.textContent = "/"; cell.classList.add('status-ok'); }
            else if (state === 2) { cell.textContent = "X"; cell.classList.add('status-bad'); }
            else { cell.textContent = ""; }
        }

        // Drag-to-fill handlers
        document.addEventListener('mousedown', (e) => {
            if (e.target.classList.contains('check-cell')) {
                isDragging = true;
                dragStartCell = e.target;
                dragStartState = (parseInt(e.target.dataset.state) + 1) % 4;
                setCellState(e.target, dragStartState);
                e.preventDefault();
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging && e.target.classList.contains('check-cell')) {
                setCellState(e.target, dragStartState);
            }
        });

        document.addEventListener('mouseup', () => {
            isDragging = false;
            dragStartCell = null;
        });

        function toggleColumn(num) {
            const cells = document.querySelectorAll(`.mach-${num}`);
            if (!cells.length) return;
            let nextState = (parseInt(cells[0].dataset.state) + 1) % 4;
            cells.forEach(cell => setCellState(cell, nextState));
        }

        function saveToHistory() {
            document.getElementById('modalInput').value = "‡∏£‡∏≠‡∏ö‡∏ï‡∏£‡∏ß‡∏à " + new Date().toLocaleDateString('th-TH');
            document.getElementById('saveModal').style.display = 'flex';
        }

        function confirmSaveHistory() {
            const label = document.getElementById('modalInput').value.trim();
            if (!label) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠");

            const cellStates = Array.from(document.querySelectorAll('.check-cell')).map(c => ({ num: c.dataset.num, state: c.dataset.state }));
            const rowRemarks = Array.from(document.querySelectorAll('.row-remark')).map(el => el.textContent);
            const remarks = Array.from(document.querySelectorAll('.correction-input')).map(el => el.textContent);
            const sigDates = Array.from(document.querySelectorAll('.date-input')).map(el => el.value);
            const sigNames = Array.from(document.querySelectorAll('.sig-name')).map(el => el.textContent);

            let metadata = {};
            if (currentFMT === 2) {
                const monthSelect = document.querySelector('.fmt02-month-select');
                const yearSelect = document.querySelector('.fmt02-year-select');
                const monthText = monthSelect && monthSelect.value ? thaiMonths[parseInt(monthSelect.value) - 1] + ' ' + yearSelect.value : '';

                metadata = {
                    mNo: document.querySelector('.fmt02-m-no')?.textContent || '',
                    month: monthText,
                    area: document.querySelector('.fmt02-area')?.textContent || '',
                    dept: document.querySelector('.fmt02-dept')?.textContent || ''
                };
            }

            const entry = {
                id: Date.now(),
                fmt: currentFMT,
                label,
                timestamp: new Date().toLocaleString('th-TH'),
                data: cellStates,
                rowRemarks,
                remarks,
                sigDates,
                sigNames,
                metadata
            };
            let history = JSON.parse(localStorage.getItem('fmt_history') || '[]');
            history.unshift(entry);
            localStorage.setItem('fmt_history', JSON.stringify(history));

            // Prepare data for Google Sheet (Flat Format)
            const checksArr = cellStates.map(c => parseInt(c.state));
            const sheetData = {
                id: entry.id,
                fmt: entry.fmt,
                date: new Date().toLocaleDateString('th-TH'),
                inspector: entry.label,
                checks: checksArr,
                corrections: remarks,
                dates: sigDates,
                rowRemarks: rowRemarks,
                jobName: entry.label,
                metadata: entry.metadata
            };
            sendToGoogleSheet(sheetData);

            document.getElementById('saveModal').style.display = 'none';
            renderHistoryList();
        }

        function renderHistoryList() {
            const container = document.getElementById('history-list');
            let history = JSON.parse(localStorage.getItem('fmt_history') || '[]');
            // Filter by current FMT
            history = history.filter(h => h.fmt === currentFMT || (currentFMT === 37 && !h.fmt));
            container.innerHTML = history.length === 0 ? '<div style="color:#94a3b8; font-size:0.8rem; text-align:center; padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>' : '';
            history.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <input type="checkbox" class="item-checkbox" data-id="${item.id}" onclick="event.stopPropagation(); handleSelectionChange()">
                    <div class="date">${toThaiDigits(item.label)}</div>
                    <div class="timestamp">${toThaiDigits(item.timestamp)}</div>
                    <button class="delete-btn" onclick="deleteHistory(${item.id}, event)">&times;</button>
                `;
                div.onclick = () => {
                    viewHistoryItem(item);
                };
                container.appendChild(div);
            });
            handleSelectionChange();
        }

        function toggleSelectAll(cb) {
            document.querySelectorAll('.item-checkbox').forEach(item => {
                item.checked = cb.checked;
            });
            handleSelectionChange();
        }

        function handleSelectionChange() {
            const checkedCount = document.querySelectorAll('.item-checkbox:checked').length;
            const totalCount = document.querySelectorAll('.item-checkbox').length;
            const printBtn = document.getElementById('printSelectedBtn');

            if (checkedCount > 0) {
                printBtn.style.display = 'flex';
                printBtn.innerHTML = `<span>üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${checkedCount})</span>`;
            } else {
                printBtn.style.display = 'none';
            }

            document.getElementById('selectAll').checked = checkedCount === totalCount && totalCount > 0;
        }

        function printSelected() {
            const checkedIds = Array.from(document.querySelectorAll('.item-checkbox:checked')).map(cb => parseInt(cb.dataset.id));
            if (checkedIds.length === 0) return;

            const history = JSON.parse(localStorage.getItem('fmt_history') || '[]');
            const selectedItems = history.filter(h => checkedIds.includes(h.id));

            const printArea = document.getElementById('print-area');
            printArea.innerHTML = '';

            selectedItems.forEach(item => {
                const formHTML = generateFormHTMLFromData(item);
                printArea.innerHTML += formHTML;
            });

            window.print();
            printArea.innerHTML = '';
        }

        function generateFormHTMLFromData(item) {
            if (item.fmt === 2) return renderStaticForm02(item);
            return renderStaticForm37(item);
        }

        function renderStaticForm37(item) {
            let fullHTML = '';
            const ranges = [1, 21, 41];

            ranges.forEach(start => {
                let machineHeaders = '';
                for (let i = 0; i < 20; i++) {
                    let num = start + i;
                    machineHeaders += `<th style="width: 28px; text-align: center;">${num <= 54 ? num : ''}</th>`;
                }

                let rowsHtml = '';
                let cellIndexOffset = 0;
                if (start == 21) cellIndexOffset = checklistData.reduce((a, g) => a + g.items.length, 0) * 20;
                if (start == 41) cellIndexOffset = checklistData.reduce((a, g) => a + g.items.length, 0) * 40;

                let localCellCounter = 0;
                checklistData.forEach(group => {
                    group.items.forEach((chkItem, idx) => {
                        const itemsCount = checklistData.reduce((a, g) => a + g.items.length, 0);
                        const rowIdxInGroup = checklistData.flatMap(g => g.items).indexOf(chkItem);
                        const tableIdx = ranges.indexOf(start);
                        const overallRowIdx = tableIdx * itemsCount + rowIdxInGroup;
                        const rowRemarkText = (item.rowRemarks && item.rowRemarks[overallRowIdx]) ? item.rowRemarks[overallRowIdx] : "";

                        rowsHtml += `<tr>
                            ${idx === 0 ? `<td rowspan="${group.items.length}" class="category-cell"><div class="vertical-text">${group.category}</div></td>` : ''}
                            <td class="col-item" style="font-size:0.75rem;">${chkItem.name}</td>
                            <td class="col-std" style="font-size:0.7rem;">${chkItem.std}</td>`;

                        for (let i = 0; i < 20; i++) {
                            let num = start + i;
                            let isExist = num <= 54;
                            let state = 0;
                            if (isExist) {
                                const cellIdxInItemData = cellIndexOffset + (rowIdxInGroup * 20) + i;
                                state = item.data[cellIdxInItemData] ? parseInt(item.data[cellIdxInItemData].state) : 0;
                            }

                            let content = "";
                            let cls = "";
                            if (state === 1) { content = "/"; cls = "status-ok"; }
                            else if (state === 2) { content = "X"; cls = "status-bad"; }
                            else if (state === 3) { content = "-"; cls = "status-na"; }

                            rowsHtml += `<td class="check-cell ${cls}" style="text-align:center; font-weight:800; border: 1px solid #000;">${content}</td>`;
                        }
                        rowsHtml += `<td style="border: 1px solid #000; font-size: 0.7rem;">${rowRemarkText}</td></tr>`;
                    });
                });

                fullHTML += `
                <div class="sheet-container" style="page-break-after: always; border:1px solid #000; margin-bottom: 20px;">
                    <header class="form-header">
                        <div class="logo-box">‚óÜ</div>
                        <div class="company-name">POLYFOAM HIGH-TECH (PFH)</div>
                        <div class="form-title">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡πÅ‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®</div>
                        <div class="form-meta">
                            <div><b>Doc No:</b> FMT-37</div>
                            <div><b>Revision:</b> 00</div>
                            <div><b>Eff. Date:</b> 01/01/2567</div>
                            <div style="margin-top:2px; color:var(--primary); font-weight:bold;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${item.timestamp.split(' ')[0]}</div>
                        </div>
                    </header>

                    <table class="main-table">
                        <thead>
                            <tr>
                                <th rowspan="2">‡∏´‡∏°‡∏ß‡∏î</th>
                                <th rowspan="2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö</th>
                                <th rowspan="2">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</th>
                                <th colspan="20">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á (Machine No.)</th>
                                <th rowspan="2">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
                            </tr>
                            <tr>${machineHeaders}</tr>
                        </thead>
                        <tbody>${rowsHtml}</tbody>
                    </table>
                    <div class="footer-section">
                        <div style="display:flex; justify-content: space-between; gap: 20px;">
                            <div style="flex:1.5;">
                                <div style="font-weight:bold; margin-bottom: 5px; border-bottom: 2px solid var(--primary); display: inline-block; font-size:0.85rem;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç (Action Taken)</div>
                                <div style="min-height: 80px; border: 1px dashed #000; padding: 8px; font-size: 0.8rem; background:#fff;">${item.remarks[ranges.indexOf(start)] || ''}</div>
                            </div>
                            <div style="flex:1;">
                                <table class="signature-table">
                                    <tr><td>‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (Recorder)</td><td>‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ (Checker)</td><td>‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ (Approver)</td></tr>
                                    <tr style="height:50px;"><td></td><td></td><td></td></tr>
                                    <tr>
                                        <td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${toThaiDateStr(item.sigDates[ranges.indexOf(start) * 3] || "")}</td>
                                        <td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${toThaiDateStr(item.sigDates[ranges.indexOf(start) * 3 + 1] || "")}</td>
                                        <td>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${toThaiDateStr(item.sigDates[ranges.indexOf(start) * 3 + 2] || "")}</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            return fullHTML;
        }

        function renderStaticForm02(item) {
            let dateHeaders = '';
            for (let i = 1; i <= 31; i++) {
                dateHeaders += `<th style="width: 20px; text-align: center;">${i}</th>`;
            }

            let rowsHtml = '';
            checklistData02.forEach(group => {
                // Category Header Row
                rowsHtml += `<tr style="background: #fdfdfd;">
                    <td colspan="2" style="text-align: left; font-weight: bold; padding-left: 5px; font-size: 0.75rem; border: 1px solid #000;">${group.category}</td>
                    ${Array(31).fill('<td style="border: 1px solid #000;"></td>').join('')}
                </tr>`;

                group.items.forEach((chkItem, idx) => {
                    rowsHtml += `<tr>
                        <td class="col-item" style="font-size:0.65rem; padding-left: 15px; border: 1px solid #000;">${chkItem.name}</td>
                        <td class="col-std" style="font-size:0.65rem; border: 1px solid #000;">${chkItem.std}</td>`;
                    for (let i = 1; i <= 31; i++) {
                        const cellIdx = checklistData02.flatMap(g => g.items).indexOf(chkItem) * 31 + (i - 1);
                        const state = item.data[cellIdx] ? parseInt(item.data[cellIdx].state) : 0;
                        let content = "";
                        let cls = "";
                        if (state === 1) { content = "/"; cls = "status-ok"; }
                        else if (state === 2) { content = "X"; cls = "status-bad"; }

                        rowsHtml += `<td class="check-cell ${cls}" style="text-align:center; font-weight:800; border: 1px solid #000; width:22px;">${content}</td>`;
                    }
                    rowsHtml += `</tr>`;
                });
            });

            const mData = item.metadata || {};

            return `<div class="sheet-container" style="page-break-after: always; margin-bottom: 20px;">
                <div style="border: 2px solid #000; margin-bottom: 0;">
                    <div class="form-header" style="border: none; border-bottom: 2px solid #000;">
                        <div class="logo-box" style="border-right: 2px solid #000; padding: 8px 15px; width: auto; flex: 1;">
                            <div class="company-name" style="font-size: 1rem; font-weight: 700;">POLYFOAM HIGH-TECH (PFH)</div>
                        </div>
                        <div class="form-title" style="flex: 2; display: flex; align-items: center; justify-content: center; padding: 8px; border-right: 2px solid #000; font-size: 1rem; font-weight: 700; text-align: center;">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏â‡∏µ‡∏î‡πÇ‡∏ü‡∏°‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô</div>
                        <div style="flex: 0.8; padding: 8px 12px; display: flex; flex-direction: column; gap: 3px; font-size: 0.75rem;">
                            <div><b>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</b> ${mData.month || '................../..................'}</div>
                            <div style="display: flex; justify-content: space-between;">
                                <span><b>FMT-02</b></span>
                                <span><b>Re:#0</b></span>
                            </div>
                        </div>
                    </div>

                    <div style="display: flex; border-bottom: 2px solid #000; font-size: 0.8rem;">
                        <div style="flex: 1.2; padding: 6px 10px; border-right: 2px solid #000;">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç / Machine No.: <span style="border-bottom: 1px solid #000; display: inline-block; min-width: 80px;">${mData.mNo || ''}</span></div>
                        <div style="flex: 2; padding: 6px 10px; border-right: 2px solid #000;">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏±‡∏Å‡∏£/Machine Name : <span style="font-weight: bold;">INJECTION MOLDING FOAM</span></div>
                        <div style="flex: 0.9; padding: 6px 10px; border-right: 2px solid #000;">‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á: <span style="border-bottom: 1px solid #000; display: inline-block; min-width: 60px;">${mData.area || ''}</span></div>
                        <div style="flex: 0.9; padding: 6px 10px;">‡πÅ‡∏ú‡∏ô‡∏Å‡∏ú‡∏•‡∏¥‡∏ï: <span style="border-bottom: 1px solid #000; display: inline-block; min-width: 60px;">${mData.dept || ''}</span></div>
                    </div>
                </div>

                <table class="main-table" style="font-size:0.6rem; width:100%; border-top: none;">
                    <thead>
                        <tr>
                            <th rowspan="2" style="width:120px;">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</th>
                            <th rowspan="2" style="width:120px;">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à</th>
                            <th colspan="31">Date/‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        </tr>
                        <tr>${dateHeaders}</tr>
                    </thead>
                    <tbody>${rowsHtml}</tbody>
                </table>
                <div style="border: 2px solid #000; border-top: none; padding: 0; margin-top: 0;">
                    <div style="display:flex;">
                        <div style="flex: 2; padding: 10px 15px; border-right: 2px solid #000; display: flex; flex-direction: column; gap: 8px;">
                            <div style="font-size: 0.85rem; font-weight: bold;">
                                ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ &nbsp;&nbsp;&nbsp; ‡∏£‡∏∞‡∏ö‡∏∏ &nbsp; / &nbsp; ‡∏õ‡∏Å‡∏ï‡∏¥ &nbsp;&nbsp; X &nbsp;&nbsp; ‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥
                            </div>
                            <div style="font-size: 0.75rem; line-height: 1.4;">
                                ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏ã‡πà‡∏≠‡∏°‡∏ö‡∏≥‡∏£‡∏∏‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏à‡∏≠‡∏™‡∏†‡∏≤‡∏û‡πÑ‡∏°‡πà‡∏õ‡∏Å‡∏ï‡∏¥‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏á‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤ ‡πÉ‡∏´‡πâ‡∏•‡∏ß‡πÑ‡∏´‡∏•‡∏´‡∏•‡∏±‡πà‡∏á‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏ú‡∏ô‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏ã‡πà‡∏≠‡∏°‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
                            </div>
                        </div>
                        <div style="flex: 1.2; padding: 0;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.7rem;">
                                <tr style="height: 25px;">
                                    <td style="border: 1px solid #000; border-left: none; border-top: none; text-align: center; width: 60px;">‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠</td>
                                    <td style="border: 1px solid #000; border-top: none; text-align: center;">‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</td>
                                    <td style="border: 1px solid #000; border-top: none; text-align: center;">‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡πÄ‡∏ä‡πá‡∏Ñ</td>
                                    <td style="border: 1px solid #000; border-right: none; border-top: none; text-align: center;">‡∏ú‡∏π‡πâ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</td>
                                </tr>
                                <tr style="height: 35px;">
                                    <td style="border: 1px solid #000; border-left: none; text-align: center;">‡∏•‡∏≤‡∏¢‡πÄ‡∏ã‡πá‡∏ô</td>
                                    <td style="border: 1px solid #000;"></td>
                                    <td style="border: 1px solid #000;"></td>
                                    <td style="border: 1px solid #000; border-right: none;"></td>
                                </tr>
                                <tr style="height: 25px;">
                                    <td style="border: 1px solid #000; border-left: none; text-align: center; font-size: 0.65rem;">‡∏ä‡∏∑‡πà‡∏≠ (‡∏ï‡∏±‡∏ß‡∏ö‡∏£‡∏£‡∏à‡∏á)</td>
                                    <td style="border: 1px solid #000;"></td>
                                    <td style="border: 1px solid #000;"></td>
                                    <td style="border: 1px solid #000; border-right: none;"></td>
                                </tr>
                                <tr style="height: 25px;">
                                    <td style="border: 1px solid #000; border-left: none; border-bottom: none; text-align: center;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</td>
                                    <td style="border: 1px solid #000; border-bottom: none; text-align: center;">___/___/______</td>
                                    <td style="border: 1px solid #000; border-bottom: none; text-align: center;">___/___/______</td>
                                    <td style="border: 1px solid #000; border-right: none; border-bottom: none; text-align: center;">___/___/______</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function applyHistoryState(item) {
            clearAll();
            const cells = document.querySelectorAll('.check-cell');
            item.data.forEach((d, i) => { if (cells[i]) setCellState(cells[i], parseInt(d.state)); });
            const remarks = document.querySelectorAll('.correction-input');
            item.remarks.forEach((txt, i) => { if (remarks[i]) remarks[i].textContent = txt; });
            const dates = document.querySelectorAll('.date-input');
            item.sigDates.forEach((val, i) => {
                if (dates[i]) {
                    dates[i].value = val;
                    if (dates[i].previousElementSibling) {
                        dates[i].previousElementSibling.innerText = toThaiDateStr(val);
                    }
                }
            });

            const rowRemarks = document.querySelectorAll('.row-remark');
            if (item.rowRemarks) {
                item.rowRemarks.forEach((txt, i) => { if (rowRemarks[i]) rowRemarks[i].textContent = txt; });
            }

            if (item.fmt === 2 && item.metadata) {
                if (document.querySelector('.fmt02-m-no')) document.querySelector('.fmt02-m-no').textContent = item.metadata.mNo || '';

                // Parse and set month/year
                if (item.metadata.month && document.querySelector('.fmt02-month-select')) {
                    const parts = item.metadata.month.split(' ');
                    if (parts.length >= 2) {
                        const monthIdx = thaiMonths.indexOf(parts[0]);
                        if (monthIdx >= 0) {
                            document.querySelector('.fmt02-month-select').value = monthIdx + 1;
                        }
                        document.querySelector('.fmt02-year-select').value = parts[1];
                    }
                }

                if (document.querySelector('.fmt02-area')) document.querySelector('.fmt02-area').textContent = item.metadata.area || '';
                if (document.querySelector('.fmt02-dept')) document.querySelector('.fmt02-dept').textContent = item.metadata.dept || '';
            }
        }

        function viewHistoryItem(item) {
            applyHistoryState(item);
            currentLoadedId = item.id;

            const badge = document.getElementById('statusBadge');
            badge.style.display = 'block';
            badge.style.background = '#e0f2fe';
            badge.style.color = '#0369a1';
            badge.style.borderColor = '#bae6fd';
            badge.innerText = `üëÄ Viewing: ${item.label}`;

            document.getElementById('editToggleBtn').style.display = 'flex';
            document.getElementById('updateBtn').style.display = 'none';
        }

        function toggleEditMode() {
            if (!currentLoadedId) return;
            const badge = document.getElementById('statusBadge');
            badge.style.background = '#fee2e2';
            badge.style.color = '#991b1b';
            badge.style.borderColor = '#fecaca';
            badge.innerText = `‚úèÔ∏è Editing: ${document.getElementById('statusBadge').innerText.replace('üëÄ Viewing: ', '')}`;

            document.getElementById('editToggleBtn').style.display = 'none';
            document.getElementById('updateBtn').style.display = 'flex';
        }

        function updateCurrentHistory() {
            if (!currentLoadedId) return;
            let history = JSON.parse(localStorage.getItem('fmt_history') || '[]');
            const idx = history.findIndex(h => h.id === currentLoadedId);
            if (idx === -1) return;

            history[idx].data = Array.from(document.querySelectorAll('.check-cell')).map(c => ({ num: c.dataset.num, state: c.dataset.state }));
            history[idx].rowRemarks = Array.from(document.querySelectorAll('.row-remark')).map(el => el.textContent);
            history[idx].remarks = Array.from(document.querySelectorAll('.correction-input')).map(el => el.textContent);
            history[idx].sigDates = Array.from(document.querySelectorAll('.date-input')).map(el => el.value);
            history[idx].timestamp = new Date().toLocaleString('th-TH') + " (Updated)";

            localStorage.setItem('fmt_history', JSON.stringify(history));

            // Send to Google Sheet
            const checksArr = history[idx].data.map(c => parseInt(c.state));
            const sheetData = {
                id: history[idx].id,
                fmt: history[idx].fmt,
                date: new Date().toLocaleDateString('th-TH'),
                inspector: history[idx].label,
                checks: checksArr,
                corrections: history[idx].remarks,
                dates: history[idx].sigDates,
                rowRemarks: history[idx].rowRemarks,
                jobName: history[idx].label,
                metadata: history[idx].metadata
            };
            sendToGoogleSheet(sheetData);

            alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            renderHistoryList();
            document.getElementById('updateBtn').style.display = 'none';
            document.getElementById('statusBadge').style.display = 'none';
            document.getElementById('editToggleBtn').style.display = 'none';
            currentLoadedId = null;
            clearAll();
        }

        function deleteHistory(id, event) {
            event.stopPropagation();
            if (!confirm("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;
            let history = JSON.parse(localStorage.getItem('fmt_history') || '[]');
            history = history.filter(h => h.id !== id);
            localStorage.setItem('fmt_history', JSON.stringify(history));
            renderHistoryList();
            if (currentLoadedId === id) {
                currentLoadedId = null;
                document.getElementById('statusBadge').style.display = 'none';
                document.getElementById('updateBtn').style.display = 'none';
            }
        }

        function markAllNormal() {
            document.querySelectorAll('.check-cell').forEach(c => {
                if (currentFMT === 37) {
                    const num = parseInt(c.dataset.num);
                    if (num <= 54 && c.dataset.state == '0') setCellState(c, 1);
                } else {
                    if (c.dataset.state == '0') setCellState(c, 1);
                }
            });
        }

        async function syncFromCloud() {
            const btn = document.querySelector('button[title="‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Cloud"]');
            if (btn) {
                btn.innerHTML = '‚è≥...';
                btn.disabled = true;
            }

            try {
                // Assuming the Script returns a JSON list of objects
                const response = await fetch(GOOGLE_SCRIPT_URL);
                if (!response.ok) throw new Error("Network response was not ok");
                const cloudData = await response.json();

                if (!Array.isArray(cloudData)) throw new Error("Invalid data format");

                let localHistory = JSON.parse(localStorage.getItem('fmt_history') || '[]');
                let newCount = 0;

                cloudData.forEach(cItem => {
                    // Check if exists
                    if (!localHistory.some(h => h.id == cItem.id)) {
                        try {
                            // Convert format
                            const appItem = {
                                id: parseInt(cItem.id) || Date.now(),
                                fmt: parseInt(cItem.fmt) || 2, // Default to 2 if missing
                                label: cItem.jobName || cItem.inspector || "No Name",
                                timestamp: cItem.date || new Date().toLocaleString('th-TH'),
                                data: (cItem.checks || []).map(s => ({ state: s })),
                                rowRemarks: cItem.rowRemarks || [],
                                remarks: cItem.corrections || [],
                                sigDates: cItem.dates || [],
                                sigNames: [], // Sheet might not have this, leave empty
                                metadata: cItem.metadata || {}
                            };
                            localHistory.push(appItem);
                            newCount++;
                        } catch (e) {
                            console.error("Error parsing item:", cItem, e);
                        }
                    }
                });

                if (newCount > 0) {
                    // Sort descending by id (timestamp)
                    localHistory.sort((a, b) => b.id - a.id);
                    localStorage.setItem('fmt_history', JSON.stringify(localHistory));
                    renderHistoryList();
                    alert(`‚úÖ ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏û‡∏¥‡πà‡∏° ${newCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà`);
                } else {
                    alert("‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß");
                }

            } catch (err) {
                console.error(err);
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: " + err.message);
            } finally {
                if (btn) {
                    btn.innerHTML = '‚òÅÔ∏è Sync';
                    btn.disabled = false;
                }
            }
        }

        function clearAll() {
            document.querySelectorAll('.check-cell').forEach(c => setCellState(c, 0));
            document.querySelectorAll('.correction-input').forEach(el => el.textContent = '');
            document.querySelectorAll('.date-input').forEach(el => el.value = '');
        }

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà ---

        // 1. ‡∏ß‡∏≤‡∏á URL ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£ Deploy ‡πÉ‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbytCloKMouYV4Mdkp_Ar0yyjIloCz4VRCbdSkNKDhf8fEkV5Bym9Cthz9-XX4uNkEsd/exec";

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet
        async function sendToGoogleSheet(data) {
            const saveBtn = document.querySelector('.btn-primary');
            try {
                saveBtn.disabled = true;
                // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ö‡∏ö POST
                await fetch(GOOGLE_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(data)
                });
                alert("‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheet ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            } catch (err) {
                alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            } finally {
                saveBtn.disabled = false;
            }
        }

        function saveLocally() {
            // ‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏≤‡∏Å Modal Input ‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô HTML
            const jobTitle = document.getElementById('modalInput').value;

            if (!jobTitle) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                return;
            }

            const checks = [];
            document.querySelectorAll('.check-cell').forEach(c => checks.push(parseInt(c.dataset.state)));

            const data = {
                id: Date.now(),
                fmt: currentFMT,
                date: new Date().toLocaleDateString('th-TH'),
                inspector: jobTitle, // ‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏≠‡∏Å‡πÉ‡∏ô Modal ‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
                checks: checks,
                jobName: jobTitle
            };

            // ‡∏™‡πà‡∏á‡πÑ‡∏õ Sheet
            sendToGoogleSheet(data);

            // ‡∏õ‡∏¥‡∏î Modal
            document.getElementById('saveModal').style.display = 'none';
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô saveLocally ‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
        function saveLocally() {
            const inspector = document.getElementById('inspectorName').value;
            const approver = document.getElementById('approverName').value;

            if (!inspector) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å");
                return;
            }

            // ‡∏£‡∏ß‡∏ö‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°
            const checks = [];
            const corrections = [];
            const dates = [];

            document.querySelectorAll('.check-cell').forEach(c => checks.push(parseInt(c.dataset.state)));
            document.querySelectorAll('.correction-input').forEach(c => corrections.push(c.textContent));
            document.querySelectorAll('.date-input').forEach(c => dates.push(c.value));

            const data = {
                id: currentLoadedId || Date.now(),
                fmt: currentFMT,
                date: document.getElementById('inspectDate').value,
                inspector: inspector,
                approver: approver,
                checks: checks,
                corrections: corrections,
                dates: dates,
                jobName: document.getElementById('jobName') ? document.getElementById('jobName').value : "",
                location: document.getElementById('location') ? document.getElementById('location').value : ""
            };

            // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á LocalStorage (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π History ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢)
            let history = JSON.parse(localStorage.getItem('fmt_history') || '[]');
            if (currentLoadedId) {
                const index = history.findIndex(h => h.id === currentLoadedId);
                if (index !== -1) history[index] = data;
            } else {
                history.unshift(data);
            }
            localStorage.setItem('fmt_history', JSON.stringify(history));

            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
            renderHistoryList();

            // --- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet ---
            sendToGoogleSheet(data);
        }

        // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô updateHistory (‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï)
        function updateHistory() {
            if (!currentLoadedId) return;
            saveLocally();
        }

    </script>

</body>

</html>
